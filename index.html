<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>LernDashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#6b46c1">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon-192.png" type="image/png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        :root {
            --primary: #6b46c1;
            --primary-light: #7e5be0;
            --danger: #e53e3e;
            --bg: #f5f7fa;
            --card: #ffffff;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --tool: #1e90ff;
            --competence: #ff8c00;
            --grade: #50c878;
            --text: #333;
            --text-light: #555;
            --favorite: #f39c12;
        }
        .dark {
            --bg: #1a1a1a;
            --card: #2d2d2d;
            --text: #e0e0e0;
            --text-light: #bbbbbb;
            --shadow: 0 1px 3px rgba(0,0,0,0.3);
            background: #111 !important;
            color: var(--text) !important;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0; padding: 20px;
            background: var(--bg); color: var(--text);
            display: flex; gap: 20px;
        }
        .main { flex: 1; min-width: 0; }
        .sidebar {
            width: 300px; background: var(--card); border-radius: 12px;
            padding: 16px; box-shadow: var(--shadow); height: fit-content;
            position: sticky; top: 20px;
        }
        .sidebar h3 { margin: 0 0 16px; color: var(--primary); font-size: 16px; text-align: center; }
        .stat-bar { margin: 12px 0; }
        .stat-bar label { display: flex; justify-content: space-between; font-size: 13px; margin-bottom: 4px; color: var(--text-light); }
        .bar-container { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; }
        .bar { height: 100%; background: var(--primary); border-radius: 5px; transition: width 0.4s ease; }
        .bar-value { font-weight: bold; color: var(--primary); }
        .logo-container { margin-bottom: 20px; text-align: center; cursor: pointer; }
        .logo-wrapper { width: 80px; height: 80px; margin: 0 auto 10px; border-radius: 50%; overflow: hidden; box-shadow: 0 6px 16px rgba(107,70,193,0.3); padding: 6px; background: white; display: flex; align-items: center; justify-content: center; }
        .logo-svg { width: 100%; height: 100%; }
        .logo-text { font-size: 18px; font-weight: 700; color: #333; }
        .logo-subtext { font-size: 13px; color: #666; }
        .filter-container { background: linear-gradient(135deg, #eef5ff, #e0edff); padding: 14px; border-radius: 12px; border: 1px solid #cce0ff; margin-bottom: 16px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); }
        .filters { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
        .filter-group { display: flex; flex-direction: column; min-width: 140px; flex: 1; }
        .filter-group label { font-size: 12px; color: #555; margin-bottom: 4px; font-weight: 600; }
        .filter-group select { padding: 8px 10px; border: 1px solid #ccc; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; }
        .search-container { position: relative; flex: 1; max-width: 400px; }
        .search-input { width: 100%; padding: 8px 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
        #suggestions { position: absolute; top: 100%; left: 0; width: 100%; background: white; border: 1px solid #ccc; max-height: 180px; overflow-y: auto; z-index: 1000; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: none; }
        #suggestions div { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #eee; }
        #suggestions div:hover { background: #f0f4ff; }
        .reset-btn { background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; }
        .export-buttons { margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap; }
        .btn { background: var(--primary); color: white; border: none; padding: 8px 14px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn.csv { background: #27ae60; } .btn.pdf { background: #e74c3c; } .btn.print { background: #34495e; } .btn.import { background: #f39c12; } .btn.template { background: #9b59b6; }
        .file-input { display: none; }
        .new-resource-btn { display: block; margin: 20px auto; padding: 14px 28px; font-size: 17px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; border: none; border-radius: 12px; cursor: pointer; box-shadow: 0 6px 16px rgba(107,70,193,0.3); transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 8px; max-width: 360px; }
        .new-resource-btn:hover { transform: translateY(-3px); box-shadow: 0 10px 24px rgba(107,70,193,0.4); }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin: 16px 0; }
        .stat-card { background: var(--card); padding: 12px; border-radius: 10px; text-align: center; box-shadow: var(--shadow); font-weight: 600; }
        .stat-card span { display: block; font-size: 22px; color: var(--primary); margin-top: 6px; }
        .resource-item { margin: 12px 0; padding: 16px; border: 1px solid #e0e0e0; border-radius: 12px; background: var(--card); box-shadow: var(--shadow); transition: transform 0.2s; }
        .resource-item:hover { transform: translateY(-2px); }
        .resource-content { margin-bottom: 12px; line-height: 1.6; font-size: 15px; }
        .tag { display: inline-block; padding: 4px 10px; margin: 2px 4px 2px 0; border-radius: 16px; font-size: 11px; color: #fff; font-weight: bold; }
        .grade-tag { background: var(--grade); } .tool-tag { background: var(--tool); } .competence-tag { background: var(--competence); }
        .description { margin-top: 10px; font-size: 13px; color: var(--text-light); background: #f8f9fa; padding: 8px; border-radius: 6px; border-left: 3px solid var(--primary); }
        .action-icons { display: flex; gap: 8px; justify-content: flex-end; align-items: center; }
        .action-icon { width: 34px; height: 34px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.15); }
        .action-icon:hover { transform: scale(1.15); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .action-icon svg { width: 18px; height: 18px; fill: currentColor; }
        .edit-icon { background: #e8f5e8; color: #27ae60; } .edit-icon:hover { background: #27ae60; color: white; }
        .delete-icon { background: #ffe8e8; color: #e74c3c; } .delete-icon:hover { background: #e74c3c; color: white; }
        .favorite-icon { background: #fff8e1; color: #f39c12; } .favorite-icon.active { background: #f39c12; color: white; }
        .action-icon[aria-label]:hover::after { content: attr(aria-label); position: absolute; bottom: -26px; left: 50%; transform: translateX(-50%); background: #333; color: white; font-size: 10px; padding: 3px 6px; border-radius: 4px; white-space: nowrap; z-index: 10; pointer-events: none; }
        #editForm { display: none; margin-top: 25px; background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .form-group { margin-bottom: 14px; }
        .form-group label { display: block; margin-bottom: 6px; font-weight: 600; font-size: 14px; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
        .form-group textarea { min-height: 90px; resize: vertical; }
        #editForm button { margin-right: 10px; padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; }
        #editForm button[type="submit"] { background: var(--primary); color: white; }
        #editForm button[type="button"] { background: #95a5a6; color: white; }
    </style>
</head>
<body>
    <!-- MAIN CONTENT (LINKS) -->
    <div class="main">
        <div class="logo-container" onclick="toggleDarkMode()">
            <div class="logo-wrapper">
                <svg class="logo-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="frameGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" stop-color="#8e67d6"/>
                            <stop offset="100%" stop-color="#5e3ab0"/>
                        </linearGradient>
                        <linearGradient id="screenGrad" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#f0f4ff"/>
                            <stop offset="100%" stop-color="#d0e0ff"/>
                        </linearGradient>
                    </defs>
                    <rect x="14" y="14" width="36" height="36" rx="8" fill="url(#frameGrad)" stroke="#4a2e8c" stroke-width="2"/>
                    <rect x="16" y="16" width="32" height="32" rx="6" fill="#ffffff"/>
                    <rect x="18" y="18" width="28" height="28" rx="4" fill="url(#screenGrad)"/>
                    <g transform="translate(21,21)">
                        <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#4caf50"/>
                        <circle cx="3.5" cy="2.5" r="1.5" fill="#fff"/>
                        <path d="M2.5 4.5h2" stroke="#fff" stroke-width="1"/>
                        <g transform="translate(9,0)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#ff9800"/>
                            <path d="M2 2l3 3m0-3l-3 3" stroke="#fff" stroke-width="1.2" stroke-linecap="round"/>
                        </g>
                        <g transform="translate(18,0)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#e91e63"/>
                            <circle cx="3.5" cy="3.5" r="2" fill="#fff"/>
                            <circle cx="4" cy="3" r="0.8" fill="#333"/>
                        </g>
                        <g transform="translate(0,9)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#f44336"/>
                            <path d="M2 5v-2l3 1v2l-3 1z" fill="#fff"/>
                            <circle cx="4.5" cy="1.5" r="1" fill="#fff"/>
                        </g>
                        <g transform="translate(9,9)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#2196f3"/>
                            <path d="M2.5 2l2.5 1.5v-3z" fill="#fff"/>
                        </g>
                        <g transform="translate(18,9)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#9c27b0"/>
                            <path d="M1.5 2h4M1.5 3.5h4M1.5 5h2" stroke="#fff" stroke-width="0.8"/>
                        </g>
                        <g transform="translate(0,18)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#3f51b5"/>
                            <path d="M1.5 5.5h1v-2h-1zM3 5.5h1v-3h-1zM4.5 5.5h1v-1h-1z" fill="#fff"/>
                        </g>
                        <g transform="translate(9,18)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#00bcd4"/>
                            <circle cx="3.5" cy="3.5" r="2.5" stroke="#fff" stroke-width="0.8" fill="none"/>
                            <path d="M1.5 3.5h4M3.5 1.5v4" stroke="#fff" stroke-width="0.6"/>
                        </g>
                        <g transform="translate(18,18)">
                            <rect x="0" y="0" width="7" height="7" rx="1.5" fill="#eeeeee"/>
                            <path d="M1.5 2h4M1.5 4h4" stroke="#999" stroke-width="0.8"/>
                            <path d="M1.5 2l.7.7m-.7-.7l1.4 1.4" stroke="#4caf50" stroke-width="1"/>
                        </g>
                    </g>
                    <circle cx="20" cy="20" r="3" fill="#fff" opacity="0.5"/>
                </svg>
            </div>
            <div class="logo-text">LernDB</div>
            <div class="logo-subtext">Digital</div>
        </div>

        <!-- FILTER -->
        <div class="filter-container">
            <div class="filters">
                <div class="filter-group">
                    <label>Fach</label>
                    <select id="filterSubject"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
                    <label>Klasse</label>
                    <select id="filterGrade"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
                    <label>Kompetenz</label>
                    <select id="filterCompetence"><option value="">Alle</option></select>
                </div>
                <div class="filter-group">
                    <label>Tool</label>
                    <select id="filterTool"><option value="">Alle</option></select>
                </div>
                <div class="search-container">
                    <label>Thema</label>
                    <input type="text" id="searchTopic" class="search-input" placeholder="z.B. Klimawandel">
                    <div id="suggestions"></div>
                </div>
                <button class="reset-btn" onclick="resetFilters()">Reset</button>
            </div>
        </div>

        <!-- KARTEN-STATISTIK -->
        <div class="stats">
            <div class="stat-card"><div>Gesamt</div><span id="statTotal">0</span></div>
            <div class="stat-card"><div>Favoriten</div><span id="statFavorites">0</span></div>
            <div class="stat-card"><div>Tools</div><span id="statTools">0</span></div>
            <div class="stat-card"><div>Fächer</div><span id="statSubjects">0</span></div>
        </div>

        <!-- EXPORT -->
        <div class="export-buttons">
            <button class="btn csv" onclick="exportCSV()">CSV</button>
            <button class="btn pdf" onclick="exportPDF()">PDF</button>
            <button class="btn print" onclick="window.print()">Drucken</button>
            <label class="btn import">Import<input type="file" accept=".csv" class="file-input" onchange="importCSV(event)"></label>
            <button class="btn template" onclick="exportTemplate()">Vorlage</button>
        </div>

        <button class="new-resource-btn" onclick="window.location.href='new-resource.html'">
            Neue Ressource
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
        </button>

        <div id="resourcesList"></div>

        <form id="editForm">
            <div class="form-group"><label>Thema *</label><input type="text" id="editTopic" required></div>
            <div class="form-group"><label>Fach *</label><select id="editSubject" required></select></div>
            <div class="form-group"><label>Klasse *</label><select id="editGrade" required></select></div>
            <div class="form-group"><label>Kompetenz *</label><select id="editCompetence" required></select></div>
            <div class="form-group"><label>Tool</label><input type="text" id="editTool"></div>
            <div class="form-group"><label>Beschreibung</label><textarea id="editDescription"></textarea></div>
            <button type="submit">Speichern</button>
            <button type="button" onclick="cancelEdit()">Abbrechen</button>
        </form>
    </div>

    <!-- SIDEBAR: NUR FÄCHER-STATISTIK -->
    <div class="sidebar">
        <h3>Fächer-Statistik</h3>
        <div id="statsFach"></div>
    </div>

    <!-- SVG SYMBOLS -->
    <svg style="display:none">
        <symbol id="edit-icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a.996.996 0 0 0 0-1.41l-2.34-2.34a.996.996 0 0 0-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></symbol>
        <symbol id="delete-icon" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="star-icon" viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></symbol>
    </svg>
    
        <script>
        // === DATEN & KONFIG ===
        let resources = JSON.parse(localStorage.getItem('resources') || '[]');
        let tools = new Set(resources.map(r => r.tool?.toLowerCase()).filter(Boolean));
        let editIndex = -1;

        const subjects = ["AWT", "Astronomie", "Biologie", "Chemie", "Deutsch", "Englisch", "Französisch", "Geografie", "Geschichte", "Gesellschaftskunde", "Informatik", "Italienisch", "Kunst", "Mathematik", "Musik", "Naturwissenschaften", "Physik", "Plattdeutsch", "Russisch", "Spanisch", "Sozialkunde", "Sport", "Wirtschaft"];
        const grades = Array.from({length: 13}, (_, i) => `Klasse ${i+1}`);
        const competences = [
            "Suchen, Verarbeiten und Aufbewahren",
            "Kommunizieren und Kooperieren",
            "Produzieren und Präsentieren",
            "Schützen und sicher Agieren",
            "Problemlösen und Handeln",
            "Analysieren und Reflektieren"
        ];

        // === DARK MODE ===
        function toggleDarkMode() {
            document.body.classList.toggle('dark');
            localStorage.setItem('darkMode', document.body.classList.contains('dark'));
        }
        if (localStorage.getItem('darkMode') === 'true') toggleDarkMode();

        // === DROPDOWNS ===
        function populateDropdowns() {
            ['filterSubject', 'editSubject'].forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '<option value="">Alle</option>';
                subjects.forEach(v => s.add(new Option(v, v)));
            });
            ['filterGrade', 'editGrade'].forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '<option value="">Alle</option>';
                grades.forEach(v => s.add(new Option(v, v)));
            });
            ['filterCompetence', 'editCompetence'].forEach(id => {
                const s = document.getElementById(id);
                s.innerHTML = '<option value="">Alle</option>';
                competences.forEach(v => s.add(new Option(v, v)));
            });
            updateToolFilter();
        }

        function updateToolFilter() {
            const s = document.getElementById('filterTool');
            s.innerHTML = '<option value="">Alle</option>';
            [...tools].sort().forEach(t => {
                s.add(new Option(t.charAt(0).toUpperCase() + t.slice(1), t));
            });
        }

        // === STATISTIK ===
        function updateStats() {
            document.getElementById('statTotal').textContent = resources.length;
            document.getElementById('statFavorites').textContent = resources.filter(r => r.favorite).length;
            document.getElementById('statTools').textContent = tools.size;
            document.getElementById('statSubjects').textContent = new Set(resources.map(r => r.subject)).size;
            updateSubjectBarStats();
        }

        function updateSubjectBarStats() {
            const count = resources.reduce((a, r) => (a[r.subject] = (a[r.subject] || 0) + 1, a), {});
            const container = document.getElementById('statsFach');
            container.innerHTML = '';
            const max = Math.max(...Object.values(count)) || 1;
            Object.entries(count)
                .sort((a, b) => b[1] - a[1])
                .forEach(([k, v]) => {
                    const div = document.createElement('div');
                    div.className = 'stat-bar';
                    div.innerHTML = `
                        <label>${k} <span class="bar-value">${v}</span></label>
                        <div class="bar-container">
                            <div class="bar" style="width:${(v / max * 100)}%"></div>
                        </div>`;
                    container.appendChild(div);
                });
        }

        // === FILTER & ANZEIGE ===
        function applyFilters() {
            const f = {
                subject: document.getElementById('filterSubject').value.toLowerCase(),
                grade: document.getElementById('filterGrade').value.toLowerCase(),
                competence: document.getElementById('filterCompetence').value.toLowerCase(),
                tool: document.getElementById('filterTool').value.toLowerCase(),
                topic: document.getElementById('searchTopic').value.toLowerCase()
            };

            const filtered = resources.filter(r =>
                (!f.subject || r.subject.toLowerCase() === f.subject) &&
                (!f.grade || r.grade.toLowerCase() === f.grade) &&
                (!f.competence || r.competence.toLowerCase() === f.competence) &&
                (!f.tool || r.tool?.toLowerCase() === f.tool) &&
                (!f.topic || r.topic.toLowerCase().includes(f.topic))
            );

            displayResources(filtered);
            updateStats();
        }

        function resetFilters() {
            ['filterSubject', 'filterGrade', 'filterCompetence', 'filterTool'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('searchTopic').value = '';
            applyFilters();
        }

        function toggleFavorite(i) {
            resources[i].favorite = !resources[i].favorite;
            localStorage.setItem('resources', JSON.stringify(resources));
            applyFilters();
        }

        function displayResources(list) {
            const c = document.getElementById('resourcesList');
            c.innerHTML = '';
            list.forEach((r, i) => {
                const d = document.createElement('div');
                d.className = 'resource-item';
                d.innerHTML = `
                    <div class="resource-content">
                        <strong>${r.topic}</strong> - ${r.subject}
                        <span class="tag grade-tag">${r.grade}</span>
                        <span class="tag competence-tag">${r.competence}</span>
                        ${r.tool ? `<span class="tag tool-tag">${r.tool}</span>` : ''}
                        ${r.description ? `<div class="description">${r.description}</div>` : ''}
                    </div>
                    <div class="action-icons">
                        <div class="action-icon favorite-icon ${r.favorite ? 'active' : ''}" onclick="toggleFavorite(${i})" aria-label="Favorit">
                            <svg><use xlink:href="#star-icon"/></svg>
                        </div>
                        <div class="action-icon edit-icon" onclick="editResource(${i})" aria-label="Bearbeiten">
                            <svg><use xlink:href="#edit-icon"/></svg>
                        </div>
                        <div class="action-icon delete-icon" onclick="deleteResource(${i})" aria-label="Löschen">
                            <svg><use xlink:href="#delete-icon"/></svg>
                        </div>
                    </div>`;
                c.appendChild(d);
            });
        }

        // === BEARBEITEN ===
        function editResource(i) {
            editIndex = i;
            const r = resources[i];
            document.getElementById('editTopic').value = r.topic;
            document.getElementById('editSubject').value = r.subject;
            document.getElementById('editGrade').value = r.grade;
            document.getElementById('editCompetence').value = r.competence;
            document.getElementById('editTool').value = r.tool || '';
            document.getElementById('editDescription').value = r.description || '';
            document.getElementById('editForm').style.display = 'block';
        }

        function cancelEdit() {
            document.getElementById('editForm').style.display = 'none';
            editIndex = -1;
        }

        document.getElementById('editForm').onsubmit = e => {
            e.preventDefault();
            if (editIndex === -1) return;
            const u = {
                topic: document.getElementById('editTopic').value.trim(),
                subject: document.getElementById('editSubject').value,
                grade: document.getElementById('editGrade').value,
                competence: document.getElementById('editCompetence').value,
                tool: document.getElementById('editTool').value.trim(),
                description: document.getElementById('editDescription').value.trim(),
                favorite: resources[editIndex].favorite,
                lastModified: new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
            };
            resources[editIndex] = u;
            localStorage.setItem('resources', JSON.stringify(resources));
            applyFilters();
            cancelEdit();
        };

        function deleteResource(i) {
            if (confirm('Sicher löschen?')) {
                resources.splice(i, 1);
                localStorage.setItem('resources', JSON.stringify(resources));
                applyFilters();
            }
        }

        // === AUTOCOMPLETE ===
        const searchInput = document.getElementById('searchTopic');
        const suggestions = document.getElementById('suggestions');
        searchInput.oninput = e => {
            suggestions.innerHTML = '';
            const v = e.target.value.toLowerCase().trim();
            if (!v) { suggestions.style.display = 'none'; return; }
            const m = [...new Set(resources.map(r => r.topic).filter(t => t.toLowerCase().includes(v)))].slice(0, 6);
            if (!m.length) { suggestions.style.display = 'none'; return; }
            m.forEach(t => {
                const d = document.createElement('div');
                d.textContent = t;
                d.onclick = () => { searchInput.value = t; suggestions.style.display = 'none'; applyFilters(); };
                suggestions.appendChild(d);
            });
            suggestions.style.display = 'block';
        };
        document.addEventListener('click', e => {
            if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.style.display = 'none';
            }
        });
        
                // === CSV-IMPORT (ROBUST & BENUTZERFREUNDLICH) ===
        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                let lines = text.split(/\r\n|\n|\r/).map(l => l.trim()).filter(l => l);
                if (lines.length < 1) { showAlert("CSV-Datei ist leer!"); return; }

                // CSV parsen mit Anführungszeichen-Unterstützung
                const parsed = parseCSV(lines);
                if (!parsed || parsed.data.length === 0) { showAlert("Keine gültigen Daten gefunden!"); return; }

                const { header, data } = parsed;
                const required = ['Thema', 'Unterrichtsfach', 'Klassenstufe', 'Kompetenzbereich'];
                const missing = required.filter(col => !header.includes(col));
                if (missing.length > 0) {
                    showAlert(`Fehlende Spalten: ${missing.join(', ')}\n\nGefundene Spalten: ${header.join(', ')}`);
                    return;
                }

                // Vorschau: erste 8 Zeilen
                const previewLines = data.slice(0, 8).map(row => {
                    return `${row.Thema || ''} | ${row.Unterrichtsfach || ''} | ${row.Klassenstufe || ''} | ${row.Digitales_Hilfsmittel || ''}`;
                }).join('\n');
                const total = data.length;

                if (!confirm(`Vorschau (max. 8 Zeilen):\n\n${previewLines}\n${total > 8 ? `\n... und ${total - 8} weitere` : ''}\n\nImportieren? (${total} Ressourcen)`)) return;

                // Import mit Fortschritt
                importWithProgress(data, header);
            };
            reader.readAsText(file, 'UTF-8');
        }

        // Hilfsfunktion: Robuster CSV-Parser (mit Anführungszeichen & Zeilenumbrüche in Feldern)
        function parseCSV(lines) {
            const result = { header: [], data: [] };
            let headerLine = lines[0];
            let dataLines = lines.slice(1);

            // Header parsen
            const headerCells = [];
            let inQuotes = false;
            let cell = '';
            for (let i = 0; i < headerLine.length; i++) {
                const char = headerLine[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                    continue;
                }
                if (char === ',' && !inQuotes) {
                    headerCells.push(cell.trim());
                    cell = '';
                } else {
                    cell += char;
                }
            }
            headerCells.push(cell.trim());
            result.header = headerCells;

            // Daten parsen
            for (let line of dataLines) {
                const row = {};
                let inQuotes = false;
                let cell = '';
                let colIndex = 0;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (i + 1 < line.length && line[i + 1] === '"') {
                            cell += '"';
                            i++;
                        } else {
                            inQuotes = !inQuotes;
                        }
                        continue;
                    }
                    if (char === ',' && !inQuotes) {
                        const headerKey = result.header[colIndex] || `col${colIndex}`;
                        row[normalizeHeader(headerKey)] = cell.trim();
                        cell = '';
                        colIndex++;
                    } else {
                        cell += char;
                    }
                }
                const headerKey = result.header[colIndex] || `col${colIndex}`;
                row[normalizeHeader(headerKey)] = cell.trim();

                // Nur Zeilen mit mindestens "Thema" importieren
                if (row.Thema) {
                    result.data.push(row);
                }
            }

            return result;
        }

        // Normalisiere Spaltennamen
        function normalizeHeader(str) {
            return str
                .replace(/Digitales Hilfsmittel/g, 'Digitales_Hilfsmittel')
                .replace(/Beschreibung/g, 'Beschreibung')
                .replace(/[^a-zA-Z0-9_]/g, '_');
        }

        // Import mit Fortschrittsdialog
        function importWithProgress(data, header) {
            let resources = JSON.parse(localStorage.getItem('resources') || '[]');
            let imported = 0;
            let skipped = 0;
            let errors = [];

            const modal = document.createElement('div');
            modal.style.cssText = `
                position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);
                display:flex;justify-content:center;align-items:center;z-index:10000;
                font-family:Segoe UI,sans-serif;
            `;
            modal.innerHTML = `
                <div style="background:#fff;padding:24px;border-radius:16px;max-width:500px;width:90%;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
                    <h3 style="margin:0 0 16px;color:#6b46c1;">Import läuft...</h3>
                    <div style="background:#f0f0f0;height:12px;border-radius:6px;overflow:hidden;margin:16px 0;">
                        <div id="progressBar" style="background:#6b46c1;width:0%;height:100%;transition:width 0.2s;"></div>
                    </div>
                    <p id="status" style="margin:8px 0;font-size:14px;color:#555;">0 von ${data.length}</p>
                    <p id="log" style="max-height:120px;overflow-y:auto;font-size:13px;color:#333;margin-top:12px;"></p>
                </div>
            `;
            document.body.appendChild(modal);

            const progressBar = modal.querySelector('#progressBar');
            const status = modal.querySelector('#status');
            const log = modal.querySelector('#log');

            const processChunk = (index) => {
                if (index >= data.length) {
                    modal.remove();
                    const summary = `Import abgeschlossen!\n\n${imported} hinzugefügt\n${skipped} übersprungen (Duplikat)\n${errors.length} Fehler`;
                    showAlert(summary + (errors.length > 0 ? '\n\nFehler: ' + errors.slice(0, 5).join('; ') : ''));
                    localStorage.setItem('resources', JSON.stringify(resources));
                    updateToolFilter();
                    applyFilters();
                    return;
                }

                const row = data[index];
                try {
                    const newRes = {
                        topic: (row.Thema || '').trim(),
                        subject: (row.Unterrichtsfach || '').trim(),
                        grade: (row.Klassenstufe || '').trim(),
                        competence: (row.Kompetenzbereich || '').trim(),
                        tool: (row.Digitales_Hilfsmittel || '').trim(),
                        description: (row.Beschreibung || '').trim(),
                        favorite: false,
                        lastModified: new Date().toLocaleDateString('de-DE', { day: '2-digit', month: '2-digit', year: 'numeric' })
                    };

                    // Duplikat prüfen (Thema + Fach + Klasse)
                    const duplicate = resources.some(r =>
                        r.topic === newRes.topic &&
                        r.subject === newRes.subject &&
                        r.grade === newRes.grade
                    );

                    if (duplicate) {
                        skipped++;
                        log.innerHTML += `<div style="color:#e67e22;">Übersprungen: Duplikat "${newRes.topic}"</div>`;
                    } else if (newRes.topic && newRes.subject && newRes.grade && newRes.competence) {
                        resources.push(newRes);
                        if (newRes.tool) tools.add(newRes.tool.toLowerCase());
                        imported++;
                    } else {
                        errors.push(`Ungültig: ${newRes.topic || 'unbekannt'}`);
                        log.innerHTML += `<div style="color:#e74c3c;">Fehler: Unvollständig "${newRes.topic}"</div>`;
                    }
                } catch (err) {
                    errors.push(`Zeile ${index + 2}: ${err.message}`);
                }

                const percent = ((index + 1) / data.length) * 100;
                progressBar.style.width = percent + '%';
                status.textContent = `${index + 1} von ${data.length}`;
                log.scrollTop = log.scrollHeight;

                setTimeout(() => processChunk(index + 1), 1); // Chunked für UI
            };

            processChunk(0);
        }

        function showAlert(message) {
            const modal = document.createElement('div');
            modal.style.cssText = `position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;justify-content:center;align-items:center;z-index:10001;`;
            modal.innerHTML = `
                <div style="background:#fff;padding:24px;border-radius:16px;max-width:400px;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
                    <p style="margin:0 0 16px;white-space:pre-line;line-height:1.5;">${message}</p>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background:#6b46c1;color:white;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600;">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // === BEISPIEL-CSV VORLAGE ===
        function exportTemplate() {
            const template = "Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Digitales Hilfsmittel,Beschreibung\nBeispiel-Thema,Deutsch,Klasse 5,Problemlösen und Handeln,GeoGebra,Beispiel-Beschreibung";
            const blob = new Blob(['\uFEFF' + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'beispiel-lerndashboard.csv';
            link.click();
        }

        // === VERBESSERTER CSV-EXPORT (ZIP + Chunked) ===
        function exportCSV() {
            if (resources.length === 0) { showAlert("Keine Daten!"); return; }
            let chunkSize = 500;
            let chunks = [];
            for (let i = 0; i < resources.length; i += chunkSize) {
                let chunk = resources.slice(i, i + chunkSize).map(r => {
                    return `"${(r.topic||'').replace(/"/g, '""')}","${r.subject||''}","${r.grade||''}","${r.competence||''}","${r.tool||''}","${(r.description||'').replace(/"/g, '""')}"`;
                }).join('\n');
                chunks.push('Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Digitales Hilfsmittel,Beschreibung\n' + chunk);
            }
            let zip = new JSZip();
            chunks.forEach((chunk, i) => zip.file(`ressourcen_teil_${i+1}.csv`, chunk));
            zip.generateAsync({type: "blob"}).then(content => {
                let link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'lerndashboard_ressourcen.zip';
                link.click();
            });
        }

        // === PDF-EXPORT PERFEKT (wie im Browser) ===
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            if (resources.length === 0) { showAlert("Keine Daten!"); return; }

            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 20;

            // Titel
            doc.setFontSize(18);
            doc.setTextColor(107, 70, 193);
            doc.text('LernDashboard – Ressourcen', pageWidth / 2, y, { align: 'center' });
            y += 10;

            // Export-Datum
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Exportiert am: ${new Date().toLocaleDateString('de-DE')}`, 15, y);
            y += 15;

            // **GLEICHE SCHRIFTGRÖSSE + FARBE VOR DEM LOOP**
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0);

            resources.forEach((r, i) => {
                if (y > 270) { doc.addPage(); y = 20; }

                // 1. Überschrift: Thema + Nummer (schwarz, 11pt, fett)
                doc.text(`${i+1}. ${r.topic}`, 15, y);

                // 2. Details – FARBE + TRENNZEICHEN
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);

                const x = 15;
                let currentX = x;

                // Fach (grau)
                doc.setTextColor(100);
                doc.text(r.subject || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.subject || '—'} | `);

                // Klasse (grau)
                doc.text(r.grade || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.grade || '—'} | `);

                // Tool: hellgrün
                doc.setTextColor(39, 174, 96);
                doc.text(r.tool || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.tool || '—'} | `);

                // Kompetenz: magenta
                doc.setTextColor(233, 30, 99);
                doc.text(r.competence || '—', currentX, y + 5);

                // ZULETZT BEARBEITET
                if (r.lastModified) {
                    doc.setTextColor(100);
                    doc.text(` Zuletzt bearbeitet: ${r.lastModified}`, 15, y + 10);
                    y += 5;
                }

                // Nächster Eintrag: zurück zu 11pt + fett + schwarz
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0);
                y += 18;
            });

            doc.save('lerndashboard_ressourcen.pdf');
        }

        // === INIT ===
        ['filterSubject','filterGrade','filterTool','filterCompetence'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });
        document.getElementById('searchTopic').addEventListener('input', applyFilters);

        populateDropdowns();
        applyFilters();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

        // === VERBESSERTER CSV-EXPORT (ZIP + Chunked) ===
        function exportCSV() {
            if (resources.length === 0) { showAlert("Keine Daten!"); return; }
            let chunkSize = 500;
            let chunks = [];
            for (let i = 0; i < resources.length; i += chunkSize) {
                let chunk = resources.slice(i, i + chunkSize).map(r => {
                    return `"${(r.topic||'').replace(/"/g, '""')}","${r.subject||''}","${r.grade||''}","${r.competence||''}","${(r.tool||'').replace(/"/g, '""')}","${(r.description||'').replace(/"/g, '""')}"`;
                }).join('\n');
                chunks.push('Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Digitales Hilfsmittel,Beschreibung\n' + chunk);
            }
            let zip = new JSZip();
            chunks.forEach((chunk, i) => zip.file(`ressourcen_teil_${i+1}.csv`, chunk));
            zip.generateAsync({type: "blob"}).then(content => {
                let link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'lerndashboard_ressourcen.zip';
                link.click();
            });
        }

        // === BEISPIEL-CSV VORLAGE ===
        function exportTemplate() {
            const template = "Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Digitales Hilfsmittel,Beschreibung\nBeispiel-Thema,Deutsch,Klasse 5,Problemlösen und Handeln,GeoGebra,Beispiel-Beschreibung";
            const blob = new Blob(['\uFEFF' + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'beispiel-lerndashboard.csv';
            link.click();
        }

        // === PDF-EXPORT PERFEKT (wie im Browser) ===
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            if (resources.length === 0) { showAlert("Keine Daten!"); return; }

            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 20;

            // Titel
            doc.setFontSize(18);
            doc.setTextColor(107, 70, 193);
            doc.text('LernDashboard – Ressourcen', pageWidth / 2, y, { align: 'center' });
            y += 10;

            // Export-Datum
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Exportiert am: ${new Date().toLocaleDateString('de-DE')}`, 15, y);
            y += 15;

            // **GLEICHE SCHRIFTGRÖSSE + FARBE VOR DEM LOOP**
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0);

            resources.forEach((r, i) => {
                if (y > 270) { doc.addPage(); y = 20; }

                // 1. Überschrift: Thema + Nummer (schwarz, 11pt, fett)
                doc.text(`${i+1}. ${r.topic}`, 15, y);

                // 2. Details – FARBE + TRENNZEICHEN
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);

                const x = 15;
                let currentX = x;

                // Fach (grau)
                doc.setTextColor(100);
                doc.text(r.subject || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.subject || '—'} | `);

                // Klasse (grau)
                doc.text(r.grade || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.grade || '—'} | `);

                // Tool: hellgrün
                doc.setTextColor(39, 174, 96);
                doc.text(r.tool || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.tool || '—'} | `);

                // Kompetenz: magenta
                doc.setTextColor(233, 30, 99);
                doc.text(r.competence || '—', currentX, y + 5);

                // ZULETZT BEARBEITET
                if (r.lastModified) {
                    doc.setTextColor(100);
                    doc.text(` Zuletzt bearbeitet: ${r.lastModified}`, 15, y + 10);
                    y += 5;
                }

                // Nächster Eintrag: zurück zu 11pt + fett + schwarz
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0);
                y += 18;
            });

            doc.save('lerndashboard_ressourcen.pdf');
        }

        // === INIT ===
        ['filterSubject','filterGrade','filterTool','filterCompetence'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });
        document.getElementById('searchTopic').addEventListener('input', applyFilters);

        populateDropdowns();
        applyFilters();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
        // === VERBESSERTER CSV-EXPORT (ZIP + Chunked) ===
        function exportCSV() {
            if (resources.length === 0) { showAlert("Keine Daten!"); return; }
            let chunkSize = 500;
            let chunks = [];
            for (let i = 0; i < resources.length; i += chunkSize) {
                let chunk = resources.slice(i, i + chunkSize).map(r => {
                    return `"${(r.topic||'').replace(/"/g, '""')}","${r.subject||''}","${r.grade||''}","${r.competence||''}","${(r.tool||'').replace(/"/g, '""')}","${(r.description||'').replace(/"/g, '""')}"`;
                }).join('\n');
                chunks.push('Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Digitales Hilfsmittel,Beschreibung\n' + chunk);
            }
            let zip = new JSZip();
            chunks.forEach((chunk, i) => zip.file(`ressourcen_teil_${i+1}.csv`, chunk));
            zip.generateAsync({type: "blob"}).then(content => {
                let link = document.createElement('a');
                link.href = URL.createObjectURL(content);
                link.download = 'lerndashboard_ressourcen.zip';
                link.click();
            });
        }

        // === BEISPIEL-CSV VORLAGE ===
        function exportTemplate() {
            const template = "Thema,Unterrichtsfach,Klassenstufe,Kompetenzbereich,Digitales Hilfsmittel,Beschreibung\nBeispiel-Thema,Deutsch,Klasse 5,Problemlösen und Handeln,GeoGebra,Beispiel-Beschreibung";
            const blob = new Blob(['\uFEFF' + template], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'beispiel-lerndashboard.csv';
            link.click();
        }

        // === PDF-EXPORT PERFEKT (wie im Browser) ===
        function exportPDF() {
            const { jsPDF } = window.jspdf;
            if (resources.length === 0) { showAlert("Keine Daten!"); return; }

            const doc = new jsPDF('p', 'mm', 'a4');
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 20;

            // Titel
            doc.setFontSize(18);
            doc.setTextColor(107, 70, 193);
            doc.text('LernDashboard – Ressourcen', pageWidth / 2, y, { align: 'center' });
            y += 10;

            // Export-Datum
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Exportiert am: ${new Date().toLocaleDateString('de-DE')}`, 15, y);
            y += 15;

            // **GLEICHE SCHRIFTGRÖSSE + FARBE VOR DEM LOOP**
            doc.setFontSize(11);
            doc.setFont('helvetica', 'bold');
            doc.setTextColor(0);

            resources.forEach((r, i) => {
                if (y > 270) { doc.addPage(); y = 20; }

                // 1. Überschrift: Thema + Nummer (schwarz, 11pt, fett)
                doc.text(`${i+1}. ${r.topic}`, 15, y);

                // 2. Details – FARBE + TRENNZEICHEN
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(9);

                const x = 15;
                let currentX = x;

                // Fach (grau)
                doc.setTextColor(100);
                doc.text(r.subject || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.subject || '—'} | `);

                // Klasse (grau)
                doc.text(r.grade || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.grade || '—'} | `);

                // Tool: hellgrün
                doc.setTextColor(39, 174, 96);
                doc.text(r.tool || '—', currentX, y + 5);
                currentX += doc.getTextWidth(`${r.tool || '—'} | `);

                // Kompetenz: magenta
                doc.setTextColor(233, 30, 99);
                doc.text(r.competence || '—', currentX, y + 5);

                // ZULETZT BEARBEITET
                if (r.lastModified) {
                    doc.setTextColor(100);
                    doc.text(` Zuletzt bearbeitet: ${r.lastModified}`, 15, y + 10);
                    y += 5;
                }

                // Nächster Eintrag: zurück zu 11pt + fett + schwarz
                doc.setFontSize(11);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(0);
                y += 18;
            });

            doc.save('lerndashboard_ressourcen.pdf');
        }

        // === INIT ===
        ['filterSubject','filterGrade','filterTool','filterCompetence'].forEach(id => {
            document.getElementById(id).addEventListener('change', applyFilters);
        });
        document.getElementById('searchTopic').addEventListener('input', applyFilters);

        populateDropdowns();
        applyFilters();
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</body>
</html>
